local S = game:GetService
local P = S("Players").LocalPlayer
local RS, IS, UIS = S("RunService"), S("InsertService"), S("UserInputService")

local DRONE_ID, ANIM_ID = 17865400476, "rbxassetid://75390215999547"
local SPEED, SMOOTH, TILT = 80, 0.2, math.rad(45)
local vel, goal = Vector3.zero, Vector3.zero

local function dirInput()
	local d = Vector3.zero
	if UIS:IsKeyDown(Enum.KeyCode.W) then d += Vector3.new(0,0,-1) end
	if UIS:IsKeyDown(Enum.KeyCode.S) then d += Vector3.new(0,0,1) end
	if UIS:IsKeyDown(Enum.KeyCode.A) then d += Vector3.new(-1,0,0) end
	if UIS:IsKeyDown(Enum.KeyCode.D) then d += Vector3.new(1,0,0) end
	if UIS:IsKeyDown(Enum.KeyCode.Space) then d += Vector3.new(0,1,0) end
	if UIS:IsKeyDown(Enum.KeyCode.LeftControl) then d += Vector3.new(0,-1,0) end
	return d.Magnitude > 0 and d.Unit or Vector3.zero
end

local function attachDrone(char)
	local ok, m = pcall(function() return IS:LoadAsset(DRONE_ID) end)
	if ok and m then
		local a = m:FindFirstChildOfClass("Accessory")
		if a then
			a.Parent = char
			local h = char:FindFirstChildOfClass("Humanoid")
			if h then h:AddAccessory(a) end
		end
	end
end

local function fly(char)
	local r, h = char:WaitForChild("HumanoidRootPart"), char:WaitForChild("Humanoid")
	local cam = workspace.CurrentCamera
	h.PlatformStand = true
	vel, goal = Vector3.zero, Vector3.zero

	RS.RenderStepped:Connect(function(dt)
		local i = dirInput()
		local w = cam.CFrame:VectorToWorldSpace(i)
		goal, vel = w * SPEED, vel:Lerp(goal, SMOOTH)
		r.Velocity, r.AssemblyAngularVelocity = vel, Vector3.zero

		local f, s = i.Z * TILT, -i.X * TILT
		local look, yaw = cam.CFrame.LookVector, math.atan2(-look.X, -look.Z)
		local goalCF = CFrame.new(r.Position) * CFrame.Angles(0, yaw, 0) * CFrame.Angles(f, 0, s)
		r.CFrame = r.CFrame:Lerp(goalCF, 0.2)
	end)
end

local function blockAnims(char)
	local h = char:WaitForChild("Humanoid")
	local a = h:FindFirstChildOfClass("Animator") or Instance.new("Animator", h)
	local anim = Instance.new("Animation")
	anim.AnimationId = ANIM_ID
	local t = a:LoadAnimation(anim)
	t:Play() task.wait() t.TimePosition = 2.1 t:AdjustSpeed(0)
	h.AnimationPlayed:Connect(function(pl)
		local id = pl.Animation and pl.Animation.AnimationId or ""
		if id ~= ANIM_ID then pl:Stop() pl:Destroy() end
	end)
end

local function setup(c)
	attachDrone(c)
	fly(c)
	blockAnims(c)
end

P.CharacterAdded:Connect(setup)
if P.Character then setup(P.Character) end
